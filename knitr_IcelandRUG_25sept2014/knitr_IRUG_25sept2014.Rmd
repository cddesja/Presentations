---
title: "Creating reproducible research with `knitr`"
author: "Christopher David Desjardins"
date: "26 September 2014"
output:
  ioslides_presentation:
    keep_md: yes
    fig_width: 4
    fig_height: 4
    fig_caption: true

---

## What is reproducible research?

```{r, include = FALSE}
library("ggplot2")
options(digits = 2)
library("ggvis")
```

```{r, echo=FALSE}
library("knitr")
```
 
"The final product of research is not only the paper itself, but also the full __computation environment__ used to produce the results in the paper such as the __code__ and __data__ necessary for reproduction of the results and building upon the research." (Xie, 2014).

Articles submitted for journals should include:

- Manuscript
- Code 
- Data

Obviously, this is not always possible!

## Tools for reproduciblity

- [R](http://r-project.org)
- [knitr](http://yihui.name/knitr/)
- [Markdown](http://daringfireball.net/projects/markdown/) or [LaTeX](http://www.latex-project.org/)

Which one should you use, see [Yihue Xie's post](http://yihui.name/en/2013/10/markdown-or-latex/). 

- [Rstudio](http://www.rstudio.com) (_recommended_, if you're not wedded to an IDE)

The developers of Rstudio are often the first to integrate the latest and greatest from `R`.

## Why `knitr`?

```{r, eval=FALSE}
install.packages("knitr")
```

How can `knitr` help us achieve reproducibility?

1. We __never__ need to copy and paste results into reports.
2. If the data changes, our models, figures, and tables are __automatically updated__.
3. From a `knitr` document we can automatically generate a report using `knit()` or extract the `R` code from it using `purl()`.
5. Generate a document from an `R` script with `stitch()`.
4. It is much more feature rich than Sweave.

## Markdown and Shiny demonstration

```{r, eval = FALSE}
if(!require("shiny"))
  install.packages("shiny")
demo("notebook", package = "knitr")
```

## Chunks

Input is evaluated in chunks. Either __code chunks__

For `knitr`, chunks are what we write `R` code in. 

    ```{r}`r ''`
    <insert R code for Markdown>
    ```

    <<>>=`r ''`
    <insert R code for LaTeX>
    @



## More on Chunks

* Chunks have a plethora of options available by default 
* You can also 'roll your own' chunk options provided they are valid `R` code.

```{r}
length(opts_chunk$get())
opts_chunk$get("engine")
```

* `knitr` works with other languagues too (python, ruby, etc) 

## `knitr` Output  
* `knitr` output may be __inline__
```{r, comment = NA, echo = FALSE}
cat("\`r <insert R code for Markdown>`\n\n\\Sexpr{<insert R code for LaTeX>}")
```
* Chunk option can be text, tabular, and graphical

## Chunk Output
* What will this generate?
    
    ```{r, cool_chunk, eval = -1, echo = FALSE, message=FALSE, fig.align ='center'}`r ''`
    
    coef(lm(dist ~ speed, data = cars))[1]
    
    ggplot(aes(x=speed, y = dist), data = cars) + geom_point(col = "#56B4E9") + geom_smooth(col = "999999") + theme_bw() + ylab("Driving Speed") + xlab("Distance to Stop")

``````

## Answer
```{r, cool_chunk, eval = -1, echo = FALSE, message=FALSE, fig.align ='center'}
coef(lm(dist ~ speed, data = cars))[1]
ggplot(aes(x=speed, y = dist), data = cars) + geom_point(col = "#56B4E9") + geom_smooth(col = "999999") + theme_bw() + ylab("Driving Speed") + xlab("Distance to Stop")
```



## Helpful Chunk Output Options
* `eval = TRUE` : Evaluate all or part of the current chunk
* `echo = TRUE` : Show all or part of the source code
* `results = 'asis'` : Writes raw output from R to the output document without markup. Helpful for creating tables with `xtable`. `markup` is the default.
* `include = TRUE` : Code chunk will be included in output. If you don't want a chunk in the output but _still_ evaluated set this to `FALSE`

## Perhaps Helpful?
```{r}
foo <- 2
bar <- foo
```

```{r eval = foo < bar, echo = FALSE}
cat("foo is greater than bar")
```

```{r eval = foo == bar, echo = FALSE}
cat("they are the same")
```

```{r, comment=NA, echo = FALSE}
cat("```{r}\nfoo <- 2\nbar <- foo\n```\n```{r eval = foo < bar, echo = FALSE}\ncat(\"foo is greater than bar\")\n```\n```{r eval = foo == bar, echo = FALSE}\ncat(\"they are the same\")\n```")
```


## Tables
Tables are easily handled with `xtable`. Make sure to specify `results = "asis"` to render the table. 
```{r, results = "asis",echo=FALSE}
library(xtable)
mod1 <- lm(dist ~ speed, data = cars)
coef_tab <- summary(mod1)$coef
print(xtable(mod1), type = "html")
```
<p>
</p>
Finer control of tables with LaTeX. Finally, we can insert our fitted model using inline code:

$\hat{dist_i} = `r coef_tab[1,1]` + `r coef_tab[2,1] ` speed_i$

## Code used
    ```{r, results = "asis", echo=FALSE}`r ''`
    library(xtable)
    mod1 <- lm(dist ~ speed, data = cars)
    coef_tab <- summary(mod1)$coef
    print(xtable(mod1), type = "html")
    ```
    
For the inline code:
```{r,comment = NA, echo = FALSE}
cat("$\\hat{dist_i} = `r coef_tab[1,1]` + `r coef_tab[2,1] ` speed_i$")
```

## Using an ioslides table

-------------------------------------------------------------
Coefficients     Estimate     Standard    t-value     Pr(>|t|)
                              Error   
-------------- ------------ ----------- ----------- ------------
`r rownames(coef_tab)[1] `    `r coef_tab[1,1]`        `r coef_tab[1,2]`        `r coef_tab[1,3]`       `r coef_tab[1,4]`  

`r rownames(coef_tab)[2] `              `r coef_tab[2,1]`      `r coef_tab[2,2]`         `r coef_tab[2,3]`       `r coef_tab[2,4]`  
-------------------------------------------------------------

## Animated figures
* Can insert animated figures
```{r fig.show ='animate', fig.height=3, fig.width=3, fig.align='center', echo = FALSE}
mtcars %>% ggvis(~wt, ~mpg, size := 300, opacity := 0.4) %>% layer_points()
```

## Figures options
* `dev = 'png'` : Sets the default graphical device. `tikz` has nicer font rendering for LaTeX 
* `fig.width` and `fig.height` : Sets width and height of the device.
* `fig.cap` and `fig.align` : Set a caption and alignment
* Can set encoding (for Icelandic characters) and dingbat font (reduces the size of pdfs).
* Can group together device options `dev.args = list(option1 = "foo", option2 = "bar")`

## `cache = TRUE`
* Caching is  helpful if you have a large document or `R` that takes a long time to certain chunks.
* Caching comparing the MD5 hash of a cached chunk with MD5 hash of the same cache when `knit()` is re-run
* You can set manual cache dependencies (i.e Chunk B depends on A) or this can be done automatically
* Adding new data won't update a cache. One way to enable this is `file.info()` function in the chunk. For example,
```{r,comment = NA, echo = FALSE}
cat("```{r, foo_time = file.info('foo.csv')$mtime}\nfoo <- read.csv(\"foo\")\n...")

```

